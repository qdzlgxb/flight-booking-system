name: æ„å»ºå’Œå‘å¸ƒDockeré•œåƒ

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•åˆ°Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=tag
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: æ„å»ºå’Œæ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        echo "release_body<<EOF" >> $GITHUB_OUTPUT
        echo "## ğŸš€ èˆªç­è´­ç¥¨ç³»ç»Ÿ - ç‰ˆæœ¬ ${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“¦ Docker é•œåƒ" >> $GITHUB_OUTPUT
        echo "- é•œåƒåœ°å€: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}\`" >> $GITHUB_OUTPUT
        echo "- æ”¯æŒæ¶æ„: linux/amd64, linux/arm64" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ³ å¿«é€Ÿéƒ¨ç½²" >> $GITHUB_OUTPUT
        echo "\`\`\`bash" >> $GITHUB_OUTPUT
        echo "# æ‹‰å–é•œåƒ" >> $GITHUB_OUTPUT
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "# è¿è¡Œå®¹å™¨" >> $GITHUB_OUTPUT
        echo "docker run -d \\" >> $GITHUB_OUTPUT
        echo "  --name flight-booking-system \\" >> $GITHUB_OUTPUT
        echo "  -p 8080:8080 \\" >> $GITHUB_OUTPUT
        echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "\`\`\`" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“‹ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_OUTPUT
        echo "- âœˆï¸ èˆªç­ä¿¡æ¯æŸ¥è¯¢å’Œé¢„è®¢" >> $GITHUB_OUTPUT
        echo "- ğŸ‘¤ ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†" >> $GITHUB_OUTPUT
        echo "- ğŸ¨ ç°ä»£åŒ–çš„å‰ç«¯ç•Œé¢" >> $GITHUB_OUTPUT
        echo "- ğŸ›¡ï¸ å®‰å…¨çš„åç«¯APIæ¥å£" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ”§ æŠ€æœ¯æ ˆ" >> $GITHUB_OUTPUT
        echo "- **å‰ç«¯**: React + TypeScript + Vite" >> $GITHUB_OUTPUT
        echo "- **åç«¯**: Spring Boot + Spring Security + JPA" >> $GITHUB_OUTPUT
        echo "- **æ•°æ®åº“**: MySQL" >> $GITHUB_OUTPUT
        echo "- **å®¹å™¨**: Spring Boot å†…åµŒ Tomcat + OpenJDK 17" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: åˆ›å»ºRelease
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: èˆªç­è´­ç¥¨ç³»ç»Ÿ ${{ github.ref_name }}
        body: ${{ steps.release_notes.outputs.release_body }}
        draft: false
        prerelease: false
        
    - name: æ„å»ºæ‘˜è¦
      run: |
        echo "## ğŸ‰ æ„å»ºå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **é•œåƒ**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ éƒ¨ç½²å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "docker run -d --name flight-booking-system -p 8080:8080 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY 